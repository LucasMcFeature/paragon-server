<!DOCTYPE html>

<!--
Application: ${applicationName}
Version: ${applicationVersion}
-->

<html>
<head>
    <meta http-equiv="Content-Type"     content="text/html; charset=UTF-8">
    <meta http-equiv="Cache-Control"    content="no-cache">
    <meta http-equiv="Pragma"           content="no-cache">
    <meta http-equiv="Expires"          content="-1">
    
    <title>${applicationName}</title>

    <!-- Assumes ROOT (implied) servlet context -->    
    <script type="text/javascript" src ="/static/${versionFolder}/kodemore/loader/kmResourceLoader.js"></script>
    <script type="text/javascript" src ="/static/${versionFolder}/app/common/script/myResourceLoader.js"></script>

    <script type="text/javascript">

        //**********************************************************
        //** navigation
        //**********************************************************
        
        var KmNavigator = {};

        KmNavigator.init = function()
        {
            KmNavigator.printState();            
            KmNavigator.bind();            
        }
        
        KmNavigator.bind = function()
        {
            $(window).bind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.unbind = function()
        {
            $(window).unbind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.handleStateChange = function()
        {
            KmNavigator.printState();

            var state = History.getState();
            var ps = state.data.pageSession;
            if ( ps === undefined )
                ps = {};
            Kmu.pageSession = ps;
            
            KmNavigator.printCurrentPage();
        }

        KmNavigator.printState = function()
        {
            var state = History.getState();
            History.log(state.url, state.title, state.data);
        }

        /**
         * Push a page on the history stack.
         * The options parameter supports the following attributes:
         *
         *      url
         *          The url to be pushed. 
         *          This is the only required attribute, and is pushed 'as is'.
         *
         *      title
         *          Although this may be used to update the browser's title, it is
         *          not well supported.  If no value is specified, we use an empty string. 
         *
         *      silent
         *          By defualt, a push normally triggers the statechange event.  
         *          If silent is set to true, the statechange event is temporarily disabled.
         */
        KmNavigator.pushPage = function(options)
        {
            var url = options.url;
            
            var title = options.title;
            if ( !title )
                title = '';
            
            var data = 
            {
                pageSession: Kmu.pageSession
            };
            
            var silent = options.silent;
            if ( silent )
            { 
                KmNavigator.unbind();
                History.pushState(data, title, url);
                KmNavigator.bind();
            }
            else
            {
                History.pushState(data, title, url);
            }
        }
        
        KmNavigator.pushUrl = function(url)
        {
            KmNavigator.pushPage({url: url});
        }

        KmNavigator.printCurrentPage = function()
        {
            Kmu.ajax(
            {
                action: "_printCurrentPage"
            });
        }

        KmNavigator.replacePageSession = function()
        {
            var state = History.getState();
            
            var data;
            data = state.data;
            data.pageSession = Kmu.pageSession;
            
            var title = state.title;
            var url = state.url;
            
            History.replaceState(data, title, url);
        }

        KmNavigator.back = function()
        {
            History.back();
        }

        //**********************************************************
        //** page load
        //**********************************************************

        function myLoad()
        {
            var version = "${versionFolder}";
            
            var options = 
            { 
                title: "${applicationName}",
                onComplete: myInstall,
                delay: 0
            };
            
            MyResourceLoader.loadAppResources(options, version);
        }
        
        function myInstall()
        {
			KmDropdownMenu.installAutoClose();	
            KmHashHistory.register(Kmu.ajaxNavigate);
            Kmu.ajaxEnter(${params});
        }
        
    </script>

</head>

<body onload="myLoad();"></body>

</html>
