<!DOCTYPE html>

<!--
Application: ${applicationName}
Version: ${applicationVersion}
-->

<html>
<head>
    <meta http-equiv="Content-Type"     content="text/html; charset=UTF-8">
    <meta http-equiv="Cache-Control"    content="no-cache">
    <meta http-equiv="Pragma"           content="no-cache">
    <meta http-equiv="Expires"          content="-1">
    
    <title>${applicationName}</title>

    <!-- Assumes ROOT (implied) servlet context -->    
    <script type="text/javascript" src ="/static/${versionFolder}/kodemore/loader/kmResourceLoader.js"></script>
    <script type="text/javascript" src ="/static/${versionFolder}/app/common/script/myResourceLoader.js"></script>

    <script type="text/javascript">

        //**********************************************************
        //** navigator
        //**********************************************************
        
        var KmNavigator = {};

        KmNavigator.init = function()
        {
            KmNavigator.bind();            
        }
        
        KmNavigator.bind = function()
        {
            $(window).bind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.unbind = function()
        {
            $(window).unbind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.handleStateChange = function()
        {
            var state = History.getState();
            var ps = state.data.pageSession;
            if ( ps === undefined )
                ps = {};
            Kmu.pageSession = ps;
            
            KmNavigator.printCurrentPage();
        }

        KmNavigator.printState = function()
        {
            var state = History.getState();
            History.log(state.url, state.title, state.data);
        }

        /**
         * Push a page on the history stack.
         * The options parameter supports the following attributes:
         *
         *      url
         *          The url to be pushed. 
         *          This is the only required attribute, and is pushed 'as is'.
         *
         *      title
         *          Although this may be used to update the browser's title, it is
         *          not well supported.  If no value is specified, we use an empty string. 
         *
         *      replace
         *          If true, do a replaceState instead of a pushState.
         *
         *      silent
         *          By defualt, a push normally triggers the statechange event.  
         *          If silent is set to true, the statechange event is temporarily disabled.
         */
        KmNavigator.pushPage = function(options)
        {
            var url = options.url;
            
            var title = options.title;
            if ( !title )
                title = '';
            
            var data = 
            {
                pageSession: Kmu.pageSession
            };

            var push = true;
            if ( options.replace )
                push = false;
                
            var silent = options.silent;
            if ( silent )
            { 
                KmNavigator.unbind();
                KmNavigator.pushOrReplace(data, title, url, push);
                KmNavigator.bind();
            }
            else
            {
                KmNavigator.pushOrReplace(data, title, url, push);
            }
        }

        KmNavigator.pushOrReplace = function(data, title, url, push)
        {
            if ( push )
                History.pushState(data, title, url);
            else
                History.replaceState(data, title, url);
        }
        
        KmNavigator.pushUrl = function(url)
        {
            KmNavigator.pushPage({url: url});
        }

        KmNavigator.printCurrentPage = function()
        {
            Kmu.ajax(
            {
                action: "_printCurrentPage"
            });
        }

        KmNavigator.replacePageSession = function()
        {
            var state = History.getState();
            
            var data;
            data = state.data;
            data.pageSession = Kmu.pageSession;
            
            var title = state.title;
            var url = state.url;
            
            History.replaceState(data, title, url);
        }

        KmNavigator.back = function()
        {
            History.back();
        }

        //**********************************************************
        //** init
        //**********************************************************

        function loadResources()
        {
            var version = "${versionFolder}";
            
            var options = 
            { 
                title: "${applicationName}",
                onComplete: init
            };
            
            MyResourceLoader.loadAppResources(options, version);
        }

        function init()
        {
            initBorderLayout();
            initDropdownMenus();
            initNavigator();
        }
        
        function initBorderLayout()
        {
            new KmBorderLayout(
            {
                parent:             "body",
                idPrefix:           "pageLayout",
                classPrefix:        "pageLayout",
                
                liveResize:         false,
                debugBorders:       false,
                
                topVisible:         false,
                topResizeable:      false,
                topSize:            50,
                topOverflow:        "visible",
                
                bottomVisible:      false,
                bottomResizeable:   false,
                bottomSize:         25,
                
                leftVisible:        false,
                leftResizeable:     false,
                leftSize:           150,
                
                rightVisible:       false,
                rightResizeable:    false,
                rightSize:          150,
                
                centerOverflow:     "auto"
            });
        }        
        
        function initDropdownMenus()
        {
            KmDropdownMenu.installAutoClose();  
        }
        
        function initNavigator()
        {
            KmNavigator.init();
            KmNavigator.pushUrl("${query}");
        }
        
    </script>

</head>

<body onload="loadResources();"></body>

</html>
