<!DOCTYPE html>

<!--
Application: ${applicationName}
Version: ${applicationVersion}
-->

<html>
<head>
    <meta http-equiv="Content-Type"     content="text/html; charset=UTF-8">
    <meta http-equiv="Cache-Control"    content="no-cache">
    <meta http-equiv="Pragma"           content="no-cache">
    <meta http-equiv="Expires"          content="-1">
    
    <title>${applicationName}</title>

    <!-- Assumes ROOT (implied) servlet context -->    
    <script type="text/javascript" src ="/static/${versionFolder}/kodemore/loader/kmResourceLoader.js"></script>
    <script type="text/javascript" src ="/static/${versionFolder}/app/common/script/myResourceLoader.js"></script>

    <script type="text/javascript">

        //**********************************************************
        //** navigation
        //**********************************************************
        
        var KmNavigator = {};

        KmNavigator.init = function()
        {
            KmNavigator.printState();            
            KmNavigator.bind();            
        }
        
        KmNavigator.bind = function()
        {
            $(window).bind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.unbind = function()
        {
            $(window).unbind('statechange', KmNavigator.handleStateChange);
        }
        
        KmNavigator.handleStateChange = function()
        {
            KmNavigator.printState();

            var ps = state.data.pageSession;
            if ( ps === undefined )
                ps = {};
            Kmu.pageSession = ps;
            
            KmNavigator.printCurrentPage();
        }

        KmNavigator.printState = function()
        {
            var state = History.getState();
            History.log(state.data, state.title, state.url);
        }

        KmNavigator.enterApp = function(params)
        {
            Kmu.ajax(
            {
                action: "_enterApp",
                argument: params
            });
        }

        KmNavigator.enterPage = function(pageToken)
        {
            var data = 
            {
                pageSession: Kmu.pageSession
            };
            
            var title = '';
            var url = '?page=' + pageToken;
                        
            History.pushState(data, title, url);
            
            Kmu.ajax(
            {
                action: "_enterPage",
                extra: pageToken
            });
        }

        KmNavigator.printCurrentPage = function()
        {
            Kmu.ajax(
            {
                action: "_printCurrentPage"
            });
        }

        KmNavigator.replacePageSession = function()
        {
            var state = History.getState();
            
            var data;
            data = state.data;
            data.pageSession = Kmu.pageSession;
            
            var title = state.title;
            var url = state.url;
            
            History.replaceState(data, title, url);
        }

        KmNavigator.back = function()
        {
            History.back();
        }

        //**********************************************************
        //** page load
        //**********************************************************

        function myLoad()
        {
            var version = "${versionFolder}";
            
            var options = 
            { 
                title: "${applicationName}",
                onComplete: myInstall,
                delay: 0
            };
            
            MyResourceLoader.loadAppResources(options, version);
        }
        
        function myInstall()
        {
			KmDropdownMenu.installAutoClose();	
            KmHashHistory.register(Kmu.ajaxNavigate);
            Kmu.ajaxEnter(${params});
        }
        
    </script>

</head>

<body onload="myLoad();"></body>

</html>
